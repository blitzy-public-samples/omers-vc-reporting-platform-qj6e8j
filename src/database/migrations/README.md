# Database Migrations with Alembic

This README provides documentation and instructions for managing database migrations using Alembic in the OMERS Ventures backend platform. Proper management of database migrations ensures that the database schema remains consistent with the application's data model.

## Overview

Alembic is used for handling database migrations in a consistent and controlled manner. It allows us to version control our database schema and make incremental changes to the database structure.

## Requirements Addressed

This documentation addresses the following requirement:

- **Database Setup and Configuration** (Technical Requirements/Feature 1: Database Setup and Configuration)
  Ensures that developers have clear instructions for managing database migrations, maintaining consistency between the database schema and the application's data model.

## Dependencies

- **env.py** (src/database/migrations/env.py): Configures the Alembic environment for database migrations, setting up the connection to the PostgreSQL database and specifying the target metadata.
- **alembic.ini** (src/database/migrations/alembic.ini): Provides configuration settings necessary for managing database migrations, ensuring that the database schema can be updated and maintained consistently.
- **001_initial** (src/database/migrations/versions/001_initial.py): Initial migration script that creates the tables defined in the database schema.

## Getting Started

1. Ensure you have Alembic installed:
   ```
   pip install alembic==1.7.5
   ```

2. Initialize the migration environment (if not already done):
   ```
   alembic init migrations
   ```

3. Configure the `alembic.ini` file with the correct database URL.

4. Edit the `env.py` file to point to your application's models.

## Creating a New Migration

To create a new migration:

1. Make changes to your SQLAlchemy models in the application code.
2. Generate a new migration script:
   ```
   alembic revision --autogenerate -m "Description of changes"
   ```
3. Review the generated migration script in the `versions` directory.
4. Apply the migration to the database:
   ```
   alembic upgrade head
   ```

## Applying Migrations

To apply all pending migrations:

```
alembic upgrade head
```

To apply migrations up to a specific version:

```
alembic upgrade <revision_id>
```

## Rolling Back Migrations

To roll back the most recent migration:

```
alembic downgrade -1
```

To roll back to a specific version:

```
alembic downgrade <revision_id>
```

## Viewing Migration History

To see the current migration version:

```
alembic current
```

To view the migration history:

```
alembic history --verbose
```

## Best Practices

1. Always review autogenerated migration scripts before applying them.
2. Test migrations on a staging environment before applying to production.
3. Include both `upgrade()` and `downgrade()` operations in your migration scripts.
4. Keep migrations small and focused on specific changes.
5. Commit migration scripts to version control along with corresponding model changes.

## Troubleshooting

If you encounter issues with migrations:

1. Ensure your database URL in `alembic.ini` is correct.
2. Check that all models are properly imported in `env.py`.
3. Verify that the current database state matches the most recent migration.
4. If autogenerate doesn't capture all changes, manually edit the migration script.

For more detailed information, refer to the [Alembic documentation](https://alembic.sqlalchemy.org/).

## Conclusion

Proper use of Alembic for database migrations is crucial for maintaining the integrity and consistency of the OMERS Ventures backend platform's database schema. By following these guidelines, we ensure smooth schema evolution and minimize potential issues during deployment and updates.